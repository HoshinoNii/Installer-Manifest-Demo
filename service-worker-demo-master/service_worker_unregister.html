<html>
<head>
  <style>
    body {
      background-color: rgba(0, 0, 0, 0);
    }
  </style>
</head>

<body>

<h1>Service Worker Unregister</h1>

<script>
  console.log("Service Worker Demo Main Thread in service_worker_unregister.html");

  // register onmessage for service worker
  if (navigator && navigator.serviceWorker) {
    //reload if page does not register service worker
    navigator.serviceWorker.onmessage = async (event) => {
      console.log("onmessage ", event);

      if (event.data === "onunregistered") {
        window.location.reload();
      }
    }

    //unregister service worker
    async function unregisterServiceWorker() {
      const allRegistrations = await navigator.serviceWorker.getRegistrations();

      let unregistered = false;
      let activeWorker = null;

      for (let registration of allRegistrations) {
        if (registration.active) {
          activeWorker = registration.active;
        }

        let result = await registration.unregister();

        if (result) {
          unregistered = true;
        }
      }

      //notify service worker unregister
      if (unregistered) {
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage("notify_unregsiter");
          return 1;
        } else if (activeWorker) {
          activeWorker.postMessage("notify_unregsiter");
          return 2;
        } else {
          const registration = await navigator.serviceWorker.getRegistration();

          if (registration) {
            if (registration.active) {
              registration.active.postMessage("notify_unregsiter");
              return 3;
            }
          }
        }
      }

      return 0;
    }

    //create unregisterServiceWorker API on window object
    window.unregisterServiceWorker = unregisterServiceWorker;

    //call unregisterServiceWorker here
    window.unregisterServiceWorker();
  }
</script>

<button onClick="onClick">Click</button>

</body>
</html>
